L.KML=L.FeatureGroup.extend({options:{async:true},initialize:function(kml,options){L.Util.setOptions(this,options);this._kml=kml;this._layers={};if(kml){this.addKML(kml,options,this.options.async);}},loadXML:function(url,cb,options,async){if(async==undefined)async=this.options.async;if(options==undefined)options=this.options;var req=new window.XMLHttpRequest();req.open('GET',url,async);try{req.overrideMimeType('text/xml');}catch(e){}
req.onreadystatechange=function(){if(req.readyState!=4)return;if(req.status==200)cb(req.responseXML,options);};req.send(null);},addKML:function(url,options,async){var _this=this;var cb=function(gpx,options){_this._addKML(gpx,options)};this.loadXML(url,cb,options,async);},_addKML:function(xml,options){var layers=L.KML.parseKML(xml);if(!layers||!layers.length)return;for(var i=0;i<layers.length;i++)
{this.fire('addlayer',{layer:layers[i]});this.addLayer(layers[i]);}
this.latLngs=L.KML.getLatLngs(xml);this.fire("loaded");},latLngs:[]});L.Util.extend(L.KML,{parseKML:function(xml){var style=this.parseStyle(xml);var el=xml.getElementsByTagName("Folder");var layers=[],l;for(var i=0;i<el.length;i++){if(!this._check_folder(el[i])){continue;}
l=this.parseFolder(el[i],style);if(l){layers.push(l);}}
el=xml.getElementsByTagName('Placemark');for(var j=0;j<el.length;j++){if(!this._check_folder(el[j])){continue;}
l=this.parsePlacemark(el[j],xml,style);if(l){layers.push(l);}}
return layers;},_check_folder:function(e,folder){e=e.parentElement;while(e&&e.tagName!=="Folder")
{e=e.parentElement;}
return!e||e===folder;},parseStyle:function(xml){var style={};var sl=xml.getElementsByTagName("Style");var attributes={color:true,width:true,Icon:true,href:true,hotSpot:true};function _parse(xml){var options={};for(var i=0;i<xml.childNodes.length;i++){var e=xml.childNodes[i];var key=e.tagName;if(!attributes[key]){continue;}
if(key==='hotSpot')
{for(var j=0;j<e.attributes.length;j++){options[e.attributes[j].name]=e.attributes[j].nodeValue;}}else{var value=e.childNodes[0].nodeValue;if(key==='color'){options.opacity=parseInt(value.substring(0,2),16)/255.0;options.color="#"+value.substring(2,8);}else if(key==='width'){options.weight=value;}else if(key==='Icon'){ioptions=_parse(e);if(ioptions.href){options.href=ioptions.href;}}else if(key==='href'){options.href=value;}}}
return options;}
for(var i=0;i<sl.length;i++){var e=sl[i],el;var options={},poptions={},ioptions={};el=e.getElementsByTagName("LineStyle");if(el&&el[0]){options=_parse(el[0]);}
el=e.getElementsByTagName("PolyStyle");if(el&&el[0]){poptions=_parse(el[0]);}
if(poptions.color){options.fillColor=poptions.color;}
if(poptions.opacity){options.fillOpacity=poptions.opacity;}
el=e.getElementsByTagName("IconStyle");if(el&&el[0]){ioptions=_parse(el[0]);}
if(ioptions.href){options.icon=new L.KMLIcon({iconUrl:ioptions.href,shadowUrl:null,iconAnchorRef:{x:ioptions.x,y:ioptions.y},iconAnchorType:{x:ioptions.xunits,y:ioptions.yunits},popupAnchor:[0,-34]});}
style['#'+e.getAttribute('id')]=options;}
return style;},parseFolder:function(xml,style){var el,layers=[],l;el=xml.getElementsByTagName('Folder');for(var i=0;i<el.length;i++){if(!this._check_folder(el[i],xml)){continue;}
l=this.parseFolder(el[i],style);if(l){layers.push(l);}}
el=xml.getElementsByTagName('Placemark');for(var j=0;j<el.length;j++){if(!this._check_folder(el[j],xml)){continue;}
l=this.parsePlacemark(el[j],xml,style);if(l){layers.push(l);}}
if(!layers.length){return;}
if(layers.length===1){return layers[0];}
return new L.FeatureGroup(layers);},parsePlacemark:function(place,xml,style){var i,j,el,options={};el=place.getElementsByTagName('styleUrl');for(i=0;i<el.length;i++){var url=el[i].childNodes[0].nodeValue;for(var a in style[url])
{if(true)
{options[a]=style[url][a];}}}
var layers=[];var parse=['LineString','Polygon','Point'];for(j in parse){if(true)
{var tag=parse[j];el=place.getElementsByTagName(tag);for(i=0;i<el.length;i++){var l=this["parse"+tag](el[i],xml,options);if(l){layers.push(l);}}}}
if(!layers.length){return;}
var layer=layers[0];if(layers.length>1){layer=new L.FeatureGroup(layers);}
var name,descr="";el=place.getElementsByTagName('name');if(el.length){name=el[0].childNodes[0].nodeValue;}
el=place.getElementsByTagName('description');for(i=0;i<el.length;i++){for(j=0;j<el[i].childNodes.length;j++){descr=descr+el[i].childNodes[j].nodeValue;}}
if(name){layer.bindPopup("<h2>"+name+"</h2>"+descr);}
return layer;},parseCoords:function(xml){var el=xml.getElementsByTagName('coordinates');return this._read_coords(el[0]);},parseLineString:function(line,xml,options){var coords=this.parseCoords(line);if(!coords.length){return;}
return new L.Polyline(coords,options);},parsePoint:function(line,xml,options){var el=line.getElementsByTagName('coordinates');if(!el.length){return;}
var ll=el[0].childNodes[0].nodeValue.split(',');return new L.KMLMarker(new L.LatLng(ll[1],ll[0]),options);},parsePolygon:function(line,xml,options){var el,polys=[],inner=[],i,coords;el=line.getElementsByTagName('outerBoundaryIs');for(i=0;i<el.length;i++){coords=this.parseCoords(el[i]);if(coords){polys.push(coords);}}
el=line.getElementsByTagName('innerBoundaryIs');for(i=0;i<el.length;i++){coords=this.parseCoords(el[i]);if(coords){inner.push(coords);}}
if(!polys.length){return;}
if(options.fillColor){options.fill=true;}
if(polys.length===1){return new L.Polygon(polys.concat(inner),options);}
return new L.MultiPolygon(polys,options);},getLatLngs:function(xml){var el=xml.getElementsByTagName('coordinates');var coords=[];for(var j=0;j<el.length;j++){coords=coords.concat(this._read_coords(el[j]));}
return coords;},_read_coords:function(el){var text="",coords=[],i;for(i=0;i<el.childNodes.length;i++){text=text+el.childNodes[i].nodeValue;}
text=text.split(/[\s\n]+/);for(i=0;i<text.length;i++){var ll=text[i].split(',');if(ll.length<2){continue;}
coords.push(new L.LatLng(ll[1],ll[0]));}
return coords;}});L.KMLIcon=L.Icon.extend({createIcon:function(){var img=this._createIcon('icon');img.onload=function(){var i=new Image();i.src=this.src;this.style.width=i.width+'px';this.style.height=i.height+'px';if(this.anchorType.x==='UNITS_FRACTION'||this.anchorType.x==='fraction'){img.style.marginLeft=(-this.anchor.x*i.width)+'px';}
if(this.anchorType.y==='UNITS_FRACTION'||this.anchorType.x==='fraction'){img.style.marginTop=(-(1-this.anchor.y)*i.height)+'px';}
this.style.display="";};return img;},_setIconStyles:function(img,name){L.Icon.prototype._setIconStyles.apply(this,[img,name])
img.anchor=this.options.iconAnchorRef;img.anchorType=this.options.iconAnchorType;img.popupAnchor=[-100,-100];}});L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default()}});L.GPX=L.FeatureGroup.extend({initialize:function(gpx,options){L.Util.setOptions(this,options);this._gpx=gpx;this._layers={};if(gpx){this.addGPX(gpx,options,this.options.async);}},loadXML:function(url,cb,options,async){if(async==undefined)async=this.options.async;if(options==undefined)options=this.options;var req=new window.XMLHttpRequest();req.open('GET',url,async);try{req.overrideMimeType('text/xml');}catch(e){}
req.onreadystatechange=function(){if(req.readyState!=4)return;if(req.status==200)cb(req.responseXML,options);};req.send(null);},addGPX:function(url,options,async){var _this=this;var cb=function(gpx,options){_this._addGPX(gpx,options)};this.loadXML(url,cb,options,async);},_addGPX:function(gpx,options){var layers=this.parseGPX(gpx,options);if(!layers)return;this.addLayer(layers);this.fire("loaded");},parseGPX:function(xml,options){var j,i,el,layers=[];var named=false,tags=[['rte','rtept'],['trkseg','trkpt']];for(j=0;j<tags.length;j++){el=xml.getElementsByTagName(tags[j][0]);for(i=0;i<el.length;i++){var l=this.parse_trkseg(el[i],xml,options,tags[j][1]);for(var k=0;k<l.length;k++){if(this.parse_name(el[i],l[k]))named=true;layers.push(l[k]);}}}
el=xml.getElementsByTagName('wpt');for(i=0;i<el.length;i++){var l=this.parse_wpt(el[i],xml,options);if(!l)continue;if(this.parse_name(el[i],l))named=true;layers.push(l);}
if(!layers.length)return;var layer=layers[0];if(layers.length>1)
layer=new L.FeatureGroup(layers);return layer;},parse_name:function(xml,layer){var i,el,name,descr="";el=xml.getElementsByTagName('name');if(el.length)name=el[0].childNodes[0].nodeValue;el=xml.getElementsByTagName('desc');for(i=0;i<el.length;i++){for(var j=0;j<el[i].childNodes.length;j++)
descr=descr+el[i].childNodes[j].nodeValue;}
if(!name)return;var txt="<h2>"+name+"</h2>"+descr;if(layer&&layer._popup===undefined)layer.bindPopup(txt);return txt;},parse_trkseg:function(line,xml,options,tag){var el=line.getElementsByTagName(tag);if(!el.length)return[];var coords=[];for(var i=0;i<el.length;i++){var ll=new L.LatLng(el[i].getAttribute('lat'),el[i].getAttribute('lon'));ll.meta={};for(var j in el[i].childNodes){var e=el[i].childNodes[j];if(!e.tagName)continue;ll.meta[e.tagName]=e.textContent;}
coords.push(ll);}
var l=[new L.Polyline(coords,options)];this.fire('addline',{line:l})
return l;},parse_wpt:function(e,xml,options){var m=new L.Marker(new L.LatLng(e.getAttribute('lat'),e.getAttribute('lon')),options);this.fire('addpoint',{point:m});return m;}});var cmsMaps={};cmsMaps.options={baseLayers:{mapBoxStreets:'Mapbox streets',mapBoxLight:'Mapbox light',openStreetMap:'Open street map',openCycleMap:'Open Cycle Map',MapQuestOpen_OSM:'Map Quest',OpenStreetMap_BlackAndWhite:'OpenStreetMap_BlackAndWhite',Hydda_Full:'Hydda_Full',Thunderforest_Outdoors:'Thunderforest_Outdoors',OpenMapSurfer_Roads:'OpenMapSurfer_Roads',Thunderforest_OpenCycleMap:'Thunderforest_OpenCycleMap',Esri_WorldTopoMap:'Esri_WorldTopoMap',Esri_DeLorme:'Esri_DeLorme',googleStreets:'googleStreets',googleStreetsWithTerain:'googleStreetsWithTerain',googleHybrid:'googleHybrid ',googleSat:'googleSat ',googleTerrain:'googleTerrain'},overlays:{},center:[44.5,16.7],zoom:7,};cmsMaps.init=function(options){L.Util.setOptions(this,options);var baseLayers={};for(i in cmsMaps.options.baseLayers){if(!cmsMaps.baseMaps.baseLayers[i].hidden){var layerData=cmsMaps.baseMaps.baseLayers[i],layer=L.tileLayer(layerData.url,layerData.options);baseLayers[cmsMaps.options.baseLayers[i]]=layer;};};var map=L.map('map',{center:cmsMaps.options.center,zoom:cmsMaps.options.zoom,layers:[baseLayers[Object.keys(baseLayers)[0]]]});map.attributionControl.setPrefix('PeroGIS');cmsMaps.map=map;var boundsLayer=L.featureGroup();var overlays={},overlayKeys=Object.keys(cmsMaps.options.overlays)
overlayKeysLength=overlayKeys.length,visibleOverlayKeysLength=overlayKeys.filter(function(overlay){return cmsMaps.options.overlays[overlay].visible}).length;overlayKeys.forEach(function(i,index){var layerData=cmsMaps.options.overlays[i];if(layerData.type=='KML'){var kmlLayer=new L.KML(layerData.source,{async:true});}else if(layerData.type=='GPX'){var kmlLayer=new L.GPX(layerData.source,{async:true});};if(layerData.visible){map.addLayer(kmlLayer);kmlLayer.on("loaded",function(e){boundsLayer.addLayer(e.target);if(Object.keys(boundsLayer._layers).length>=visibleOverlayKeysLength){map.fitBounds(boundsLayer.getBounds());};});};overlays[layerData.name]=kmlLayer;});L.control.layers(baseLayers,overlays).addTo(map);};cmsMaps.baseMaps={};cmsMaps.baseMaps.attributions={openStreetMap:'&copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',openStreetMapFull:'&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',mapBox:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, '+
'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, '+
'Imagery © <a href="http://mapbox.com">Mapbox</a>',mapQuest:'Tiles &copy; <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" />',google:'Map data &copy; <a target="attr" href="http://googlemaps.com">Google</a>',};cmsMaps.baseMaps.baseLayers={mapBoxStreets:{name:'Mapbox streets',url:'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw',options:{id:'mapbox.streets',attribution:cmsMaps.baseMaps.attributions.mapBox,}},mapBoxLight:{name:'Mapbox light',url:'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw',options:{id:'mapbox.light',attribution:cmsMaps.baseMaps.attributions.mapBox,}},openStreetMap:{name:'Open street map',url:'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',options:{attribution:cmsMaps.baseMaps.attributions.openStreetMapFull}},openCycleMap:{name:'Open Cycle Map',url:'http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png',options:{attribution:'&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, Map data '+cmsMaps.baseMaps.attributions.openStreetMap}},cloudMade:{name:'CloudMade',url:'http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png',hidden:true,options:{attribution:'Map data '+cmsMaps.baseMaps.attributions.openStreetMap+', Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',styleId:997,key:null}},MapQuestOpen_OSM:{name:'Map Quest',url:'http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.png',options:{subdomains:'1234',type:'osm',attribution:'Map data '+cmsMaps.baseMaps.attributions.openStreetMap+', '+cmsMaps.baseMaps.attributions.mapQuest}},OpenStreetMap_BlackAndWhite:{name:'OpenStreetMap_BlackAndWhite',url:'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png',options:{attribution:cmsMaps.baseMaps.attributions.openStreetMap}},Hydda_Full:{name:'Hydda_Full',url:'http://{s}.tile.openstreetmap.se/hydda/full/{z}/{x}/{y}.png',options:{attribution:'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data '+cmsMaps.baseMaps.attributions.openStreetMap}},Thunderforest_Outdoors:{name:'Thunderforest_Outdoors',url:'http://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png',options:{attribution:'&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, Map data '+cmsMaps.baseMaps.attributions.openStreetMap}},OpenMapSurfer_Roads:{name:'OpenMapSurfer_Roads',url:'http://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}',options:{attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data '+cmsMaps.baseMaps.attributions.openStreetMap,maxZoom:20,}},Thunderforest_OpenCycleMap:{name:'Thunderforest_OpenCycleMap',url:'http://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png',options:{attribution:'&copy; <a href="http://www.opencyclemap.org">OpenCycleMap</a>, '+cmsMaps.baseMaps.attributions.openStreetMap}},Esri_WorldTopoMap:{name:'Esri_WorldTopoMap',url:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',options:{attribution:'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'}},Esri_DeLorme:{name:'Esri_DeLorme',url:'http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',options:{attribution:'Tiles &copy; Esri &mdash; Copyright: &copy;2012 DeLorme',minZoom:1,maxZoom:11}},googleStreets:{name:'googleStreets',url:'http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',options:{attribution:cmsMaps.baseMaps.attributions.google,maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}},googleStreetsWithTerain:{name:'googleStreetsWithTerain',url:'http://{s}.google.com/vt/lyrs=t,m&x={x}&y={y}&z={z}',options:{attribution:cmsMaps.baseMaps.attributions.google,maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}},googleHybrid:{name:'googleHybrid ',url:'http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',options:{attribution:cmsMaps.baseMaps.attributions.google,maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}},googleSat:{name:'googleSat ',url:'http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',options:{attribution:cmsMaps.baseMaps.attributions.google,maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}},googleTerrain:{name:'googleTerrain',url:'http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',options:{attribution:cmsMaps.baseMaps.attributions.google,maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}},};